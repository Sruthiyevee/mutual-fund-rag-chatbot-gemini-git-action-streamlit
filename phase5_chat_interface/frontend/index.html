<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MF Facts - Mutual Fund Assistant</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Marked for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body {
            background-color: #1a1a1a;
            color: #e5e5e5;
            font-family: 'Inter', sans-serif;
        }

        .glass-header {
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #333;
        }

        .message-user {
            background-color: #00d09c;
            color: #000;
            border-radius: 18px 18px 4px 18px;
        }

        .message-assistant {
            background-color: #2d2d2d;
            color: #e5e5e5;
            border-radius: 18px 18px 18px 4px;
        }

        .source-container {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .source-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: #9ca3af;
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 4px;
        }

        .source-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .source-item {
            font-size: 0.75rem;
            color: #d1d5db;
            padding: 2px 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .source-item:before {
            content: "â€¢";
            color: #6b7280;
        }

        .suggestion-btn {
            background-color: #2d2d2d;
            border: 1px solid #444;
            color: #00d09c;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            transition: all 0.2s;
            text-align: left;
        }

        .suggestion-btn:hover {
            background-color: #333;
            border-color: #00d09c;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #444;
        }
    </style>
</head>

<body class="h-screen flex flex-col">
    <div id="root" class="h-full flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Icons as Components
        const InfoIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#000" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10" /><path d="M12 16v-4" /><path d="M12 8h.01" /></svg>
        );
        const SendIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13" /><polygon points="22 2 15 22 11 13 2 9 22 2" /></svg>
        );
        const LoaderIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56" /></svg>
        );

        // API Endpoint
        const API_URL = "http://127.0.0.1:8000/chat";

        // Sample Questions (Onboarding)
        const SAMPLE_QUESTIONS = [
            "What is the investment objective of HDFC Large Cap Fund?",
            "What are the risks associated with mutual funds?",
            "Who is eligible to invest in HDFC Mutual Fund?",
            "How is NAV calculated?",
            "What is a Systematic Investment Plan (SIP)?"
        ];

        function App() {
            const [messages, setMessages] = useState([]);
            const [inputValue, setInputValue] = useState("");
            const [isLoading, setIsLoading] = useState(false);
            const [sessionId] = useState(`session-${Math.random().toString(36).substr(2, 9)}`);
            const chatEndRef = useRef(null);

            // Auto-scroll to bottom
            const scrollToBottom = () => {
                chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            // Initial Welcome Message
            useEffect(() => {
                setMessages([{
                    id: 1,
                    role: 'assistant',
                    content: "Welcome to the **Mutual Fund FAQ Assistant**! I can answer factual questions based on HDFC and AMFI documents.",
                    sources: [],
                    suggestions: []
                }]);
            }, []);

            const handleSend = async (text) => {
                if (!text.trim()) return;

                const userMsg = { id: Date.now(), role: 'user', content: text };
                setMessages(prev => [...prev, userMsg]);
                setInputValue("");
                setIsLoading(true);

                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: text, session_id: sessionId })
                    });

                    if (!response.ok) throw new Error(`Server returned ${response.status} ${response.statusText}`);

                    const data = await response.json();

                    const assistantMsg = {
                        id: Date.now() + 1,
                        role: 'assistant',
                        content: data.answer,
                        sources: data.sources || [],
                        suggestions: data.suggestions || []
                    };
                    setMessages(prev => [...prev, assistantMsg]);
                } catch (error) {
                    console.error("Error:", error);
                    setMessages(prev => [...prev, {
                        id: Date.now() + 1,
                        role: 'assistant',
                        content: `**Connection Error**: ${error.message}. Please ensure the backend is running on port 8000.`,
                        sources: [],
                        suggestions: []
                    }]);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSend(inputValue);
                }
            };

            return (
                <div className="flex flex-col h-full max-w-4xl mx-auto w-full relative">
                    {/* Header */}
                    <header className="glass-header p-4 flex items-center justify-between sticky top-0 z-10">
                        <div className="flex items-center gap-2">
                            <div className="bg-[#00d09c] p-2 rounded-lg">
                                <InfoIcon />
                            </div>
                            <div>
                                <h1 className="text-lg font-bold text-white">MF Facts</h1>
                                <p className="text-xs text-gray-400">Verified mutual fund facts. No advice.</p>
                            </div>
                        </div>
                    </header>

                    {/* Chat Area */}
                    <main className="flex-1 overflow-y-auto p-4 pb-32 space-y-6">
                        {messages.map((msg, idx) => (
                            <div key={msg.id} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[85%] space-y-2`}>
                                    <div className={`p-4 ${msg.role === 'user' ? 'message-user' : 'message-assistant'}`}>
                                        <div className="prose prose-invert prose-sm max-w-none" dangerouslySetInnerHTML={{ __html: msg.role === 'assistant' ? marked.parse(msg.content) : msg.content }}></div>
                                    </div>

                                    {/* Sources */}
                                    {msg.sources && msg.sources.length > 0 && msg.sources[0] !== "" && (
                                        <div className="source-container">
                                            <div className="source-title">
                                                <span>ðŸ”—</span> Sources:
                                            </div>
                                            <ul className="source-list">
                                                {msg.sources.map((src, i) => (
                                                    <li key={i} className="source-item">
                                                        {src.startsWith('http') ? (
                                                            <a href={src} target="_blank" rel="noopener noreferrer" className="text-blue-400 hover:underline break-all">
                                                                {src.split('/').pop().replace(/%20/g, ' ') || src}
                                                            </a>
                                                        ) : (
                                                            <span>{src}</span>
                                                        )}
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>
                                    )}

                                    {/* Suggestions (Fallback) */}
                                    {msg.suggestions && msg.suggestions.length > 0 && (
                                        <div className="flex flex-col gap-2 mt-2">
                                            <p className="text-xs text-gray-500 mb-1">Try asking:</p>
                                            {msg.suggestions.map((sugg, i) => (
                                                <button key={i} onClick={() => handleSend(sugg)} className="suggestion-btn">
                                                    {sugg}
                                                </button>
                                            ))}
                                        </div>
                                    )}

                                    {/* Onboarding Suggestions (Only show on first assistant message if history is empty-ish) */}
                                    {idx === 0 && messages.length === 1 && (
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-2 mt-4">
                                            {SAMPLE_QUESTIONS.map((q, i) => (
                                                <button key={i} onClick={() => handleSend(q)} className="suggestion-btn text-center">
                                                    {q}
                                                </button>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}

                        {isLoading && (
                            <div className="flex justify-start">
                                <div className="message-assistant p-4 flex items-center gap-2">
                                    <LoaderIcon />
                                    <span className="text-sm text-gray-400">Checking facts...</span>
                                </div>
                            </div>
                        )}
                        <div ref={chatEndRef} />
                    </main>

                    {/* Input Area */}
                    <footer className="p-4 bg-[#1a1a1a] border-t border-[#333] sticky bottom-0">
                        <div className="relative flex items-center gap-2 bg-[#2d2d2d] border border-[#444] rounded-full px-4 py-2 focus-within:border-[#00d09c] transition-colors">
                            <input
                                type="text"
                                value={inputValue}
                                onChange={(e) => setInputValue(e.target.value)}
                                onKeyDown={handleKeyDown}
                                placeholder="Ask a question about mutual funds..."
                                className="flex-1 bg-transparent text-white placeholder-gray-500 outline-none text-sm"
                                disabled={isLoading}
                            />
                            <button
                                onClick={() => handleSend(inputValue)}
                                disabled={isLoading || !inputValue.trim()}
                                className={`p-2 rounded-full transition-colors ${!inputValue.trim() ? 'text-gray-600' : 'text-[#00d09c] hover:bg-[#333]'}`}
                            >
                                <SendIcon />
                            </button>
                        </div>
                        <p className="text-center text-[10px] text-gray-600 mt-2">
                            This assistant provides factual information from public sources only. It does not provide investment advice.
                        </p>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>